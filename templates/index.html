<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>BeachVolley Analyzer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #f1f1f1;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      color: #00bfff;
    }
    .card {
      background: #1e1e1e;
      padding: 1.5rem;
      border-radius: 10px;
      margin: 1rem auto;
      width: 90%;
      max-width: 600px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
    }
    input[type="file"], input[type="text"] {
      background: #2c2c2c;
      color: white;
    }
    button {
      background: #00bfff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .progress {
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar {
      height: 20px;
      width: 0%;
      background: #4caf50;
      text-align: center;
      line-height: 20px;
      color: white;
    }
    video {
      display: block;
      margin: 30px auto 0 auto;
      max-width: 100%;
      border: 2px solid #00bfff;
      border-radius: 10px;
    }
    .status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>BeachVolley Analyzer</h1>

  <div class="card">
    <label>Carica un video (GoPro o altro):</label>
    <input type="file" id="videoFile">
    <button onclick="handleUpload()">Carica e Analizza</button>
  </div>

  <div class="card">
    <label>Scarica video da YouTube:</label>
    <input type="text" id="youtubeUrl" placeholder="Incolla link YouTube">
    <button onclick="handleDownload()">Scarica e Analizza</button>
  </div>

  <div class="card">
    <div class="progress"><div class="progress-bar" id="progressBar">0%</div></div>
    <div class="status" id="statusText">Stato: In attesa</div>
    <video id="videoPlayer" controls style="display:none;"></video>
  </div>

  <script>
    const progressBar = document.getElementById("progressBar");
    const statusText = document.getElementById("statusText");
    const videoPlayer = document.getElementById("videoPlayer");

    function updateProgress(percent, text) {
      progressBar.style.width = percent + "%";
      progressBar.innerText = percent + "%";
      statusText.innerText = text;
    }

    function handleUpload() {
      const file = document.getElementById("videoFile").files[0];
      if (!file) return alert("Seleziona un file.");
      const formData = new FormData();
      formData.append("file", file);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/upload", true);
      xhr.upload.onprogress = (e) => {
        const percent = Math.round((e.loaded / e.total) * 100);
        updateProgress(percent, "Upload in corso...");
      };
      xhr.onload = () => {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.error) {
            updateProgress(100, "Errore: " + response.error);
          } else if (response.output) {
            updateProgress(100, "Analisi completata");
            videoPlayer.src = response.output;
            videoPlayer.style.display = "block";
          } else {
            updateProgress(100, "Errore sconosciuto nella risposta.");
          }
        } catch {
          updateProgress(100, "Errore durante upload.");
        }
      };
      xhr.send(formData);
    }

    function handleDownload() {
      const url = document.getElementById("youtubeUrl").value;
      if (!url) return alert("Inserisci un link YouTube.");
      const formData = new FormData();
      formData.append("url", url);
      updateProgress(0, "Download in corso...");

      fetch("/youtube", { method: "POST", body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            updateProgress(100, "Errore: " + data.error);
          } else if (data.output) {
            updateProgress(100, "Analisi completata");
            videoPlayer.src = data.output;
            videoPlayer.style.display = "block";
          } else {
            updateProgress(100, "Errore sconosciuto nella risposta.");
          }
        })
        .catch(() => {
          updateProgress(0, "Errore di rete durante download.");
        });
    }
  </script>
</body>
</html>
